<!doctype html>
<html>
<head>
    <title>FMETP STREAM: FM WebSocket 6</title>
    <script src="lib/gunzip.min.js"></script>
    <style>
        table
        {
            padding:4px;
            height:15px;
            border:2px solid black;
            border-radius:10px;
        }
        td
        {
            height:20px;
        }
        body
        {
          text-align:left;
        }
    </style>
</head>
<body>
    <!-- Region Begin: You may commented and remove below script, if you don't need any Demo UI buttons, input Text or any info -->
    <h2 style="text-align:center"> FMETP STREAM: FM WebSocket 6 (Demo Receiver)</h2>
    <table style="width:100%;">
        <tr>
            <th><span id="StatusTextConnection">Status: no connection</span></th>
            <!-- <th>IP Address <input type="text" id="IpAddress" value="http://localhost:3000"></th> -->
            <th><button onclick="ConnectAsRoom()"><Strong id="BtnRoomText">JoinOrCreateRoom</Strong></button></th>
            <th>Room Name <input type="text" id="RoomName" value="MyRoomTest"></th>
        </tr>
    </table>
    <!-- Region End: You may commented and remove below script, if you don't need any Demo UI buttons, input Text or any info -->

    <!-- The important part of displaying streaming result -->
    <!-- <img id="DisplayImg" src="" width=100% /> -->

    <!-- <canvas id="canvas" /> -->
</body>
<script>
document.addEventListener('visibilitychange', () => {
    if (document.visibilityState === 'visible') {
        console.log('Tab became active again, reloading...');
        window.location.reload(); // same as pressing F5
    }
});
</script>
<script type="text/javascript">
    function FMHTML_SetElementById(inputID, inputValue)
    {
      try { document.getElementById(inputID).innerHTML = inputValue; } catch{}
      try { document.getElementById(inputID).value = inputValue; } catch{}
    }
    function FMHTML_GetElementById(inputID, defaultValue) { try { return document.getElementById(inputID).value; } catch { return defaultValue; } }
    console.log("User agent:", navigator.userAgent);
    console.log("WebSocket supported:", "WebSocket" in window);
</script>
<!-- <script src="lib/fmvpx.js"></script> -->
<script src="lib/fmwebm.js"></script>
<script src="lib/fmlog.js"></script>


<script type="text/javascript">
    let IP = "http://127.0.0.1:3000/";
    {
      // Get the full current URL
      const url_protocol = window.location.protocol;
      const url_hostName = window.location.hostname;
      const url_port = window.location.port;
      const url_ws = url_protocol + "//" + url_hostName + ":" +url_port;
      IP = url_ws;
    }
    FMHTML_SetElementById("IpAddress", IP);

    let label_img = 1001;
    let dataID_img = 0;
    let dataLength_img = 0;
    let receivedLength_img = 0;
    let dataByte_img = new Uint8Array(0);
    let ReadyToGetFrame_img = true;
    let isDesktopFrame = false;

    let label_aud = 2001;
    let dataID_aud = 0;
    let dataLength_aud = 0;
    let receivedLength_aud = 0;
    let dataByte_aud = new Uint8Array(100);
    let ReadyToGetFrame_aud = true;
    let SourceSampleRate = 44100;
    let SourceChannels = 1;
    let ABuffer = new Float32Array(0);

    let ws;
    let wsid="null";
    let roomName="MyRoomTest";
    roomName = Math.floor(1000 + Math.random() * 9000);
    roomName = FMHTML_SetElementById("RoomName", roomName);

    function ResetButtons()
    {
      FMHTML_SetElementById("BtnRoomText", "JoinOrCreateRoom");
      FMHTML_SetElementById("StatusTextConnection", "Status: no connection");

      FMHTML_SetElementById("StatusTextString", "(string) null");
      FMHTML_SetElementById("StatusTextBytes", "(byte) null");
      FMHTML_SetElementById("StatusTextVideoInfo", "info: null");
      FMHTML_SetElementById("StatusTextVideo", "(kB) ");
      FMHTML_SetElementById("StatusTextAudioInfo", "info: null");
      FMHTML_SetElementById("StatusTextAudio", "(kB) ");
    }
    function FMWebSocketDisconnect()
    {
        if (ws != null) ws.close();
        ws = null;
        ResetButtons();
    }

    function FMWebSocketEvent(inputType, inputVariable)
    {
      if (ws && ws.readyState === WebSocket.OPEN) { ws.send("fmevent" + ":" + inputType + ":" + inputVariable); }
    }

    function ConnectAsRoom()
    {
        roomName = FMHTML_GetElementById("RoomName", roomName);
        if(ws != null) { FMWebSocketDisconnect(); }
        else { FMWebSocketConnect("Room",roomName); }
    }

    function FMWebSocketConnect(targetNetworkType, targetRoomName)
    {
        function RegisterRoom(inputRoomName) { FMWebSocketEvent("roomName", inputRoomName); }
        function FMEventEncode(inputType, inputVariable) { return "fmevent" + ":" + inputType + ":" + inputVariable; }
        function FMEventDecode(inputString) { return inputString.split(":"); }
        function OnMessageCheck(message)
        {
           console.log('OnMessageCheck:' + message);
           if (message.includes("fmevent:"))
           {
             let decodedResult = FMEventDecode(message);
             let decodedType = decodedResult[1];
             let decodedValue = decodedResult[2];
             switch(decodedType)
             {
               case 'OnReceivedWSIDEvent': wsid = decodedValue; break;
               case 'OnJoinedLobbyEvent': RegisterRoom(targetRoomName); break;
             }
           }
        }

        IP = FMHTML_GetElementById("IpAddress", IP);
        IP = IP.replace('http://', 'ws://');
        IP = IP.replace('https://', 'wss://');
        try
        {
          ws = new WebSocket(IP);
          ws.binaryType = 'arraybuffer';
          ws.onopen = function(evt) { onOpen(evt) };
          ws.onclose = function(evt) { onClose(evt) };
          ws.onmessage = function(evt) { onMessage(evt) };
          ws.onerror = function(evt) { onError(evt) };
        }
        catch (e) { console.error("Exception:", e); }
        console.log("ws Add Events: " + IP);
        function RegisterNetworkType() { FMWebSocketEvent("networkType", targetNetworkType); }
        function onOpen (evt)
        {
          if (ws === null) return;
          RegisterNetworkType();
          console.log("**connected to server");
        }

        function onClose (evt)
        {
          if (ws === null) return;
          console.log("**close");
          ResetButtons();
        }
        function onError (evt)
        {
          if (ws === null) return;
          console.log("**error");
          FMWebSocketDisconnect();
          ResetButtons();
        }
        function onMessage(evt)
        {
            if (ws === null) return;
            FMHTML_SetElementById("StatusTextConnection", "Room: " + (roomName) + "(wsid: " + wsid + ")" + "\n" + new Date().getHours() + ":" + new Date().getMinutes() + ":" + new Date().getSeconds());
            FMHTML_SetElementById("BtnRoomText", "Disconnect");

            let data = evt.data;

            if (typeof evt.data === "string")
            {
              //console.log('string data!');
              OnMessageCheck(new String(evt.data));
            }

            if(evt.data instanceof ArrayBuffer)
            {
              //first 4 bytes are for FMWebSocket structure
              let _byteRaw = new Uint8Array(evt.data);
              let _byteData;
              if (_byteRaw[1] === 3)
              {
                let _wsidByteLength = ByteToInt16(_byteRaw, 4);
                _byteData = _byteRaw.slice(_wsidByteLength + 6, _byteRaw.length);
              }
              else
              {
                  _byteData = _byteRaw.slice(4, _byteRaw.length);
              }
              //first 4 bytes are for FMWebSocket structure

              // --> WEBM detection
              let isWebM = FMWebMPlayer.isWebMHeaderStart(_byteData);
              // if (isWebM > 0)
              {
                FMWebMPlayer.DecodeWebM(_byteData, isWebM);
                return;
              }
              // --> WEBM detection

            }
          };
    }

    function CombineInt8Array(a, b, offset)
    {
        let c = new Int8Array(a.length);
        c.set(a);
        c.set(b, offset);
        return c;
    }

    function CombineFloat32Array(a, b)
    {
        let c = new Float32Array(a.length + b.length);
        c.set(a);
        c.set(b, a.length);
        return c;
    }

    function ByteToInt32(_byte, _offset) { return (_byte[_offset] & 255) + ((_byte[_offset + 1] & 255) << 8) + ((_byte[_offset + 2] & 255) << 16) + ((_byte[_offset + 3] & 255) << 24); }
    function ByteToInt16(_byte, _offset) { return (_byte[_offset] & 255) + ((_byte[_offset + 1] & 255) << 8); }

    function FMSendByte(inputDataByte, inputSendType)
    {
      let _meta = new Uint8Array(4);
      _meta[0] = 0;
      _meta[1] = inputSendType;
      let _sendByte = new Uint8Array(inputDataByte.length + _meta.length);
      _sendByte = CombineInt8Array(_sendByte, _meta, 0);
      _sendByte = CombineInt8Array(_sendByte, inputDataByte, 4);
      ws.send(_sendByte);
    }
    function FMSendString(inputString, inputSendType)
    {
      let _stringBytes = Uint8Array.from(inputString, (x) => x.charCodeAt(0));
      let _meta = new Uint8Array(4);
      _meta[0] = 1;
      _meta[1] = inputSendType;
      let _sendByte = new Uint8Array(_meta.length + _stringBytes.length);
      _sendByte = CombineInt8Array(_sendByte, _meta, 0);
      _sendByte = CombineInt8Array(_sendByte, _stringBytes, 4);
      ws.send(_sendByte);
    }
    function FMSendByteToAll(inputDataByte) { FMSendByte(inputDataByte, 0); }
    function FMSendByteToServer(inputDataByte) { FMSendByte(inputDataByte, 1); }
    function FMSendByteToOthers(inputDataByte) { FMSendByte(inputDataByte, 2); }
    function FMSendStringToAll(inputString) { FMSendString(inputString, 0); }
    function FMSendStringToServer(inputString) { FMSendString(inputString, 1); }
    function FMSendStringToOthers(inputString) { FMSendString(inputString, 2); }
    function TestByteToAll(_DataByteLength) { FMSendByteToAll(new Uint8Array(_DataByteLength)); }
    function TestByteToServer(_DataByteLength) { FMSendByteToServer(new Uint8Array(_DataByteLength)); }
    function TestByteToOthers(_DataByteLength) { FMSendByteToOthers(new Uint8Array(_DataByteLength)); }
  </script>

</html>
